#!/usr/bin/perl -w

use strict;
my %RULES;

my $start = shift or die "Missing parameter N1";
my $end = shift or die "Missing parameter N2";

my $SHORTEN_STATS_FOR_BIG_RULES = 1;
my $SHORTEN_STATS_THRESHOLD = 27;
my $SHORTEN_STATS_CYCLES_TO_CONSIDER = 10;

sub calc_with_size($)
{

  my ($size) = @_;

  foreach (keys %RULES)
  {
    /^([\d|\.]+)\s+(\d+)/;

    my $rule = $2;

    # Let's not find all cycles in "big" CAs

    my $shorten = '';
    
    if ($size >= $SHORTEN_STATS_THRESHOLD and $SHORTEN_STATS_FOR_BIG_RULES)
    {
      $shorten = "| head -$SHORTEN_STATS_CYCLES_TO_CONSIDER";
    }

    open(FINDCYCLE, "./ca-findcycles $rule $size 2>/dev/null $shorten |") || die ("Can't start ./ca-findcycles: $!");

    my $max_cycle = 0;
    my $max_rule  = 0;

    my $avg_cycle = 0;
    my $ncycles = 0;

    while(<FINDCYCLE>)
    {
      chomp;

      if ($_ > $max_cycle)
      {
        $max_cycle = $_;
        $max_rule = $rule;
      }

      $avg_cycle += $_;
      $ncycles ++;
    }

    close FINDCYCLE;
    close DATA;
  
    $avg_cycle /= $ncycles;

    print "$size,$rule,$max_cycle,$avg_cycle,$ncycles\n";
  }
}

while(<DATA>)
{
  chomp;
  $RULES{$_} = 1;
}

for ($start .. $end)
{
  calc_with_size $_;
}

__DATA__
23.000 1164622485
23.000 1771656805
23.000 1767287397
23.000 2510924438
23.000 2589284954
23.000 1512416730
23.000 1448711850
23.000 2509875798
23.000 2774111590
23.000 2526455145
23.000 1217967975
23.000 2527484330
23.000 2790893910
23.000 2773854809
23.000 1718195561
23.000 2859111829
23.000 1452632469
23.000 1515612521
23.000 2779339174
23.000 2510662230
23.000 1788438873
23.000 2523240854
23.000 1653841260
23.000 2527499610
23.000 1768265369
23.000 1318433130
23.000 2577033578
23.000 2577033573
23.000 2572839510
23.000 2778028634
23.000 1771395498
23.000 1722459733
23.000 2523555174
23.000 2510973529
23.000 1687722855
23.000 1432005285
23.000 2526434661
22.968 1722389861
22.968 2774968662
22.968 2773834390
22.968 1717151146
22.964 835374645
22.964 1721128613
22.950 2505419354
22.950 2590402201
22.950 1771477658
22.950 2779158873
22.950 2861913706
22.950 2522441046
22.950 1516874342
22.950 2506463834
22.950 2773853846
22.918 2858768729
22.918 1783994794
22.900 1771657829
22.900 2846512474
22.700 2845484629
22.000 2790872729
22.000 1768249945
22.000 2457169290
22.000 1452910186
22.000 1718004058
22.000 3425055705
22.000 2573641062
22.000 3653117505
22.000 2572855909
22.000 455271645
22.000 2635490025
22.000 1704368810
22.000 2481220635
22.000 2854049250
22.000 2526452326
22.000 2578081366
22.000 2840963733
22.000 2573575829
22.000 1767478890
22.000 2572835157
22.000 2857719145
22.000 2572528218
22.000 2774898265
