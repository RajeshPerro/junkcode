#!/usr/bin/perl -wT

use strict;
use CGI;

$ENV{"PATH"} = '';
delete @ENV{qw(IFS CDPATH ENV BASH_ENV)}; 

# params
my $DEBUG = 0;

# regular expressions for validation
my %regex;
$regex{'rule'}   = '^\d{1,10}$';
$regex{'bool'}   = '^y|n$';
$regex{'action'} = '^index|rule|about$';
$regex{'initialconf'} = '^[1|0]{1,10}$';
$regex{'dimension'} = '^\d{1,4}$';

# functions
sub get_var_safe ($$$);
sub action_index ();
sub action_rule ();
sub action_about ();
sub html_header_show ($);
sub html_footer_show ();

# actions
my %actions;

$actions{'index'} = \&action_index;
$actions{'rule'}  = \&action_rule;
$actions{'about'} = \&action_about;

my $query = new CGI;


my $a = get_var_safe "action", $regex{'action'}, 'index';
$actions{$a}();

exit 0;

sub
get_var_safe ($$$)
{
  my ($param_name, $regex, $default_value) = @_;

  $_ = $query->param($param_name);

  return $default_value
    if (!defined($_) or $_ eq '');

  print "$param_name is defined\n"
    if $DEBUG;
 
  if (/$regex/)
  {
    print "$param_name passed $regex\n"
      if $DEBUG;
    return $_;
  }

  print "$param_name failed $regex\n"
    if $DEBUG;

  return $default_value;
}

sub action_index ()
{
  html_header_show("Available Rules");
  
  print "<b>Diehard Score / RULE</b><br><br>";

  while (<DATA>)
  {
    /^([\d|\.]+)\s+(\d+)/;
    print "$1 <a href=\"?action=rule&menu=y&rule=$2\">$2</a><br>";
  }
  
  html_footer_show();
}

sub action_rule ()
{
  my $img  = get_var_safe "img", $regex{'bool'}, 'n'; # show image
  my $menu = get_var_safe "menu", $regex{'bool'}, 'n'; # show menu
  my $rule = get_var_safe "rule", $regex{'rule'}, '0';

  if ($img eq 'y')
  {
    my $init   = get_var_safe "initialconf", $regex{'initialconf'}, 'random';
    my $width  = get_var_safe "w", $regex{'dimension'}, 512;
    my $height = get_var_safe "h", $regex{'dimension'}, 256;

    print $query->header('image/png');

    $ENV{'CA_RULE'} = $rule;
    $ENV{'CA_FILE'} = 'stdout';
    $ENV{'CA_INITIALCONF'} = $init
      unless $init eq 'random';
    $ENV{'CA_WIDTH'} = $width;
    $ENV{'CA_HEIGHT'} = $height;
    
    system "./ca-r2-1d-to-img";
  }
  elsif ($menu eq 'y')
  {
    html_header_show("Rule $rule detailed");

    my $req="action=rule&img=y&rule=$rule";

    for(('1','11','101','111','1101', '1011','1111', 'random'))
    {
      my $conf = "&initialconf=$_";

      print "<center>Initial configuration = $_</center>";
      print '<img src="?' . $req . $conf . '" />';
      print '<hr>';
    }

    html_footer_show();
  }
  else
  {
    html_header_show("Invalid request");
    print "<h1>Bark Bark</h1>";
    html_footer_show();
  }
}

sub action_about ()
{
  html_header_show("About");
  print '<a href="http://geocities.com/arhuaco/">Nelson Castillo</a>, 2005.';
  html_footer_show();
}

sub html_header_show ($)
{
  my ($title) = @_;

  print "Content-type: text/html\n\n" ; 
  print "<html><head><title>$title</title></head><body>";
}

sub html_footer_show ()
{
  print "</body></html>";
}

__DATA__
23.000 1164622485
23.000 1771656805
23.000 1767287397
23.000 2510924438
23.000 2589284954
23.000 1512416730
23.000 1448711850
23.000 2509875798
23.000 2774111590
23.000 2526455145
23.000 1217967975
23.000 2527484330
23.000 2790893910
23.000 2773854809
23.000 1718195561
23.000 2859111829
23.000 1452632469
23.000 1515612521
23.000 2779339174
23.000 2510662230
23.000 1788438873
23.000 2523240854
23.000 1653841260
23.000 2527499610
23.000 1768265369
23.000 1318433130
23.000 2577033578
23.000 2577033573
23.000 2572839510
23.000 2778028634
23.000 1771395498
23.000 1722459733
23.000 2523555174
23.000 2510973529
23.000 1687722855
23.000 1432005285
23.000 2526434661
22.968 1722389861
22.968 2774968662
22.968 2773834390
22.968 1717151146
22.964 835374645
22.964 1721128613
22.950 2505419354
22.950 2590402201
22.950 1771477658
22.950 2779158873
22.950 2861913706
22.950 2522441046
22.950 1516874342
22.950 2506463834
22.950 2773853846
22.918 2858768729
22.918 1783994794
22.900 1771657829
22.900 2846512474
22.700 2845484629
22.000 2790872729
22.000 1768249945
22.000 2457169290
22.000 1452910186
22.000 1718004058
22.000 3425055705
22.000 2573641062
22.000 3653117505
22.000 2572855909
22.000 455271645
22.000 2635490025
22.000 1704368810
22.000 2481220635
22.000 2854049250
22.000 2526452326
22.000 2578081366
22.000 2840963733
22.000 2573575829
22.000 1767478890
22.000 2572835157
22.000 2857719145
22.000 2572528218
22.000 2774898265
21.968 1721395558
21.957 3492163545
21.957 2589631845
21.950 1783978585
21.950 2035058355
21.900 2790681238
21.882 1449482582
21.850 3196469625
21.000 2424401790
21.000 3784187505
20.800 2859047526
17.857 1718260125
17.839 2846054997
17.000 2239322774
16.226 2231794170
15.774 3310709395
15.129 1683724196
15.129 1234937460
15.032 374990501
15.000 910676393
15.000 1454550093
15.000 2597677356
15.000 1435849642
14.968 1436260454
14.613 3316265813
14.536 2790696618
14.452 2203286697
14.000 2779206204
14.000 1788645735
14.000 2239405205
14.000 450459014
13.935 378661182
13.839 911657133
13.516 982242660
13.355 2505452009
13.000 3399899557
13.000 1634234007
13.000 2745785427
13.000 1772770963
13.000 1181309397
13.000 982881882
13.000 912939413
13.000 1788171683
13.000 740020965
13.000 1788454039
12.581 2727826774
12.032 413918037
12.000 2878687860
12.000 1044763030
12.000 848730543
12.000 2056660329
12.000 3830651565
12.000 1804899686
12.000 3281336168
12.000 2505730723
12.000 3058254774
12.000 2526831955
12.000 3398799726
12.000 1967559578
12.000 2811779413
12.000 3274923210
12.000 2489772825
12.000 2794673500
12.000 1790674260
12.000 874236135
12.000 2510070379
12.000 2837927633
12.000 2505403027
12.000 1231300347
12.000 2854574713
11.903 2791380838
11.032 1800985126
11.000 3861199962
11.000 2788533925
11.000 1147397787
11.000 313185645
11.000 228832886
11.000 1822773662
11.000 3054918373
11.000 893837998
11.000 1989575513
11.000 2050590118
11.000 2785433853
11.000 3365705571
11.000 1486313065
11.000 1826263829
11.000 945530533
10.742 609966774
10.000 368225897
10.000 3445889763
10.000 3090112853
10.000 2710428259
10.000 2647400851
10.000 899148354
10.000 2897438277
10.000 3227917205
10.000 3982836398
10.000 1754969389
10.000 2251988405
10.000 2201901750
10.000 2479189046
10.000 1695995484
10.000 2841285230
10.000 3663933533
10.000 1553635987
10.000 712860612
10.000 1420208747
10.000 2745321069
10.000 3097834779
10.000 2259145065
10.000 3335207332
10.000 963741612
10.000 2207898723
9.613 2980713303
9.000 1708206734
9.000 2503590854
9.000 2519340517
9.000 760388220
9.000 3459850963
9.000 363226814
9.000 850044503
9.000 887659287
9.000 1420514905
9.000 964052390
9.000 1805752425
9.000 2778343891
8.000 1860202390
8.000 1532655338
8.000 1527625432
8.000 3373699957
8.000 3495077167
8.000 1048150470
6.516 1920735829
6.516 2258419861
6.516 1563938209
6.516 1412861119
6.516 2825016395
6.516 113032917
6.516 2303016545
6.516 1368648117
6.516 2260241077
6.516 2235898193
6.516 1968519550
6.516 108827605
6.516 240949217
6.516 2055093105
6.484 1419036315
6.484 2866095557
6.484 2041679781
6.484 2039991425
6.484 3134629075
6.484 1155093546
6.484 1989845406
6.484 2036562538
6.484 2094765092
6.484 2166586721
6.484 1534707584
6.484 1437845941
6.484 1914496670
6.484 1989965653
6.452 2123153566
6.355 1350729887
6.355 1981474990
6.258 2286294655
6.065 1994967722
6.000 1462661322
6.000 1434681985
6.000 390064872
6.000 1418120107
6.000 2378380657
6.000 1361468138
6.000 1906689681
6.000 393208456
6.000 1522024037
6.000 1896043118
6.000 2038931637
5.484 226729166
5.484 2381788757
5.484 2719182331
5.000 2891977855
5.000 172545761
5.000 2234717041
5.000 2373399914
5.000 2773826417
5.000 2246390641
5.000 2168672597
5.000 1898141562
4.000 2077121966
4.000 2004514526
4.000 1397641454
4.000 3290694419
4.000 2694164273
4.000 3826779431
4.000 2829951281
4.000 328202172
4.000 321641916
4.000 2261885205
4.000 1914451786
4.000 1464492478
4.000 1472881342
4.000 3233268499
4.000 3328454199
4.000 2826022161
4.000 3701742298
4.000 2000584186
4.000 1998474938
4.000 1382823018
3.484 4039751470
3.484 1557828655
3.387 2740282446
3.355 3008636230
3.000 2929188885
3.000 1242786928
3.000 2034775982
3.000 2228868397
2.000 2129578165
2.000 480648145
2.000 1581172369
2.000 2228802615
2.000 2164486478
2.000 2140033934
1.000 875027013
1.000 1017535301
1.000 358110269
1.000 869639623
1.000 484136253
1.000 1138451500
1.000 81433641
1.000 1562663894
1.000 1221080889
